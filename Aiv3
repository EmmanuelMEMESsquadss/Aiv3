-- ADVANCED MOBILE GAME DUMPER - Arceus X Optimized
-- Saves to multiple locations with fallback support

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")

-- ========================================
-- CONFIGURATION
-- ========================================
local CONFIG = {
	DUMP_SCRIPTS = true,
	DUMP_MODULES = true,
	DUMP_REMOTES = true,
	DUMP_INSTANCES = true,
	INCLUDE_WORKSPACE = true,
	MAX_DEPTH = 15,
	
	-- Android paths (multiple fallbacks)
	SAVE_PATHS = {
		"/storage/emulated/0/Download/",        -- Downloads folder (most accessible)
		"/storage/emulated/0/Documents/",       -- Documents folder
		"/sdcard/Download/",                    -- Alternative SD card path
		"/sdcard/Documents/",                   -- Alternative documents
		"workspace/",                            -- Executor workspace (default)
		"",                                      -- Current directory fallback
	}
}

-- ========================================
-- STORAGE & OUTPUT
-- ========================================
local dumpData = {
	Scripts = {},
	Modules = {},
	Remotes = {},
	Instances = {},
	GameInfo = {},
	Timestamp = os.date("%Y-%m-%d_%H-%M-%S"),
	Stats = {ScriptsFound = 0, ModulesFound = 0, RemotesFound = 0}
}

-- ========================================
-- UTILITY FUNCTIONS
-- ========================================
local function getPath(instance)
	local path = {}
	local current = instance
	while current and current ~= game do
		table.insert(path, 1, current.Name)
		current = current.Parent
	end
	return table.concat(path, ".")
end

local function safeGetSource(script)
	local success, source = pcall(function()
		return script.Source
	end)
	return success and source or nil
end

local function getProperties(instance)
	local props = {
		ClassName = instance.ClassName,
		Name = instance.Name,
		Parent = instance.Parent and instance.Parent.Name or "nil"
	}
	
	-- Try common properties
	local tryProps = {"Position", "Size", "CFrame", "Color", "Transparency", "Text", "Value", "Enabled"}
	for _, prop in ipairs(tryProps) do
		pcall(function()
			local val = instance[prop]
			if val then
				if typeof(val) == "Vector3" then
					props[prop] = string.format("Vector3.new(%.2f, %.2f, %.2f)", val.X, val.Y, val.Z)
				elseif typeof(val) == "CFrame" then
					local p = val.Position
					props[prop] = string.format("CFrame.new(%.2f, %.2f, %.2f)", p.X, p.Y, p.Z)
				elseif typeof(val) == "Color3" then
					props[prop] = string.format("Color3.new(%.2f, %.2f, %.2f)", val.R, val.G, val.B)
				else
					props[prop] = tostring(val)
				end
			end
		end)
	end
	
	return props
end

-- ========================================
-- DUMPING FUNCTIONS
-- ========================================
local function dumpScript(script)
	local source = safeGetSource(script)
	if not source or source == "" then return false end
	
	local scriptData = {
		Name = script.Name,
		Type = script.ClassName,
		Path = getPath(script),
		Source = source,
		Enabled = pcall(function() return script.Enabled end) and script.Enabled or true,
		Parent = script.Parent and script.Parent.Name or "Unknown"
	}
	
	if script:IsA("ModuleScript") then
		table.insert(dumpData.Modules, scriptData)
		dumpData.Stats.ModulesFound = dumpData.Stats.ModulesFound + 1
	else
		table.insert(dumpData.Scripts, scriptData)
		dumpData.Stats.ScriptsFound = dumpData.Stats.ScriptsFound + 1
	end
	
	return true
end

local function dumpRemote(remote)
	if remote:IsA("RemoteEvent") or remote:IsA("RemoteFunction") or 
	   remote:IsA("BindableEvent") or remote:IsA("BindableFunction") then
		table.insert(dumpData.Remotes, {
			Name = remote.Name,
			Type = remote.ClassName,
			Path = getPath(remote),
			Parent = remote.Parent and remote.Parent.Name or "Unknown"
		})
		dumpData.Stats.RemotesFound = dumpData.Stats.RemotesFound + 1
		return true
	end
	return false
end

local function scanContainer(container, depth)
	if depth > CONFIG.MAX_DEPTH then return end
	
	local success, children = pcall(function() return container:GetChildren() end)
	if not success then return end
	
	for _, child in ipairs(children) do
		pcall(function()
			-- Dump scripts/modules
			if CONFIG.DUMP_SCRIPTS then
				if child:IsA("LocalScript") or child:IsA("Script") or child:IsA("ModuleScript") then
					dumpScript(child)
				end
			end
			
			-- Dump remotes
			if CONFIG.DUMP_REMOTES then
				dumpRemote(child)
			end
			
			-- Dump instances
			if CONFIG.DUMP_INSTANCES and depth <= 3 then
				table.insert(dumpData.Instances, {
					Name = child.Name,
					Type = child.ClassName,
					Path = getPath(child),
					Properties = getProperties(child)
				})
			end
			
			-- Recurse
			if #child:GetChildren() > 0 then
				scanContainer(child, depth + 1)
			end
		end)
	end
end

-- ========================================
-- MAIN DUMP EXECUTION
-- ========================================
local function collectGameInfo()
	dumpData.GameInfo = {
		PlaceId = game.PlaceId,
		GameId = game.GameId,
		Name = game.Name or "Unknown",
		CreatorId = game.CreatorId,
		CreatorType = tostring(game.CreatorType),
		JobId = game.JobId,
		Players = #Players:GetPlayers(),
	}
end

local function startDump()
	print("==========================================")
	print("ADVANCED MOBILE GAME DUMPER - STARTING")
	print("==========================================\n")
	
	collectGameInfo()
	
	local containers = {
		{game.ReplicatedStorage, "ReplicatedStorage"},
		{game.Lighting, "Lighting"},
		{game.StarterGui, "StarterGui"},
		{game.StarterPack, "StarterPack"},
		{game.StarterPlayer, "StarterPlayer"},
	}
	
	if CONFIG.INCLUDE_WORKSPACE then
		table.insert(containers, {workspace, "Workspace"})
	end
	
	-- Try server-side
	pcall(function()
		table.insert(containers, {game.ServerScriptService, "ServerScriptService"})
		table.insert(containers, {game.ServerStorage, "ServerStorage"})
	end)
	
	-- Scan all containers
	for _, container in ipairs(containers) do
		print("üìÇ Scanning: " .. container[2])
		scanContainer(container[1], 0)
	end
	
	print("\n==========================================")
	print("‚úÖ DUMP COMPLETE!")
	print("üìú Scripts: " .. dumpData.Stats.ScriptsFound)
	print("üì¶ Modules: " .. dumpData.Stats.ModulesFound)
	print("üì° Remotes: " .. dumpData.Stats.RemotesFound)
	print("üìÅ Instances: " .. #dumpData.Instances)
	print("==========================================\n")
end

-- ========================================
-- OUTPUT GENERATION
-- ========================================
local function generateTextOutput()
	local output = {}
	
	table.insert(output, "=".rep(80))
	table.insert(output, "ROBLOX GAME DUMP REPORT")
	table.insert(output, "Generated: " .. dumpData.Timestamp)
	table.insert(output, "Place: " .. dumpData.GameInfo.Name .. " (" .. dumpData.GameInfo.PlaceId .. ")")
	table.insert(output, "=".rep(80))
	table.insert(output, "\n")
	
	-- Game Info
	table.insert(output, "[GAME INFO]")
	for key, value in pairs(dumpData.GameInfo) do
		table.insert(output, string.format("  %s: %s", key, tostring(value)))
	end
	table.insert(output, "\n")
	
	-- Scripts
	if #dumpData.Scripts > 0 then
		table.insert(output, "\n" .. "=".rep(80))
		table.insert(output, "[SCRIPTS - " .. #dumpData.Scripts .. " FOUND]")
		table.insert(output, "=".rep(80))
		for i, script in ipairs(dumpData.Scripts) do
			table.insert(output, string.format("\n--- [%d] %s (%s) ---", i, script.Name, script.Type))
			table.insert(output, "Path: " .. script.Path)
			table.insert(output, "Parent: " .. script.Parent)
			table.insert(output, "\nSOURCE CODE:\n" .. ("-".rep(40)))
			table.insert(output, script.Source)
			table.insert(output, ("-".rep(40)) .. "\n")
		end
	end
	
	-- Modules
	if #dumpData.Modules > 0 then
		table.insert(output, "\n" .. "=".rep(80))
		table.insert(output, "[MODULES - " .. #dumpData.Modules .. " FOUND]")
		table.insert(output, "=".rep(80))
		for i, module in ipairs(dumpData.Modules) do
			table.insert(output, string.format("\n--- [%d] %s ---", i, module.Name))
			table.insert(output, "Path: " .. module.Path)
			table.insert(output, "\nSOURCE CODE:\n" .. ("-".rep(40)))
			table.insert(output, module.Source)
			table.insert(output, ("-".rep(40)) .. "\n")
		end
	end
	
	-- Remotes
	if #dumpData.Remotes > 0 then
		table.insert(output, "\n" .. "=".rep(80))
		table.insert(output, "[REMOTES - " .. #dumpData.Remotes .. " FOUND]")
		table.insert(output, "=".rep(80))
		for i, remote in ipairs(dumpData.Remotes) do
			table.insert(output, string.format("[%d] %s (%s)", i, remote.Name, remote.Type))
			table.insert(output, "    Path: " .. remote.Path)
		end
	end
	
	-- Instance summary
	if #dumpData.Instances > 0 then
		table.insert(output, "\n" .. "=".rep(80))
		table.insert(output, "[INSTANCES - Top 50]")
		table.insert(output, "=".rep(80))
		for i = 1, math.min(50, #dumpData.Instances) do
			local inst = dumpData.Instances[i]
			table.insert(output, string.format("[%d] %s (%s)", i, inst.Name, inst.Type))
		end
	end
	
	table.insert(output, "\n" .. "=".rep(80))
	table.insert(output, "END OF REPORT")
	table.insert(output, "=".rep(80))
	
	return table.concat(output, "\n")
end

-- ========================================
-- SAVE FUNCTIONS
-- ========================================
local function tryWriteFile(filename, content)
	-- Try multiple paths
	for _, basePath in ipairs(CONFIG.SAVE_PATHS) do
		local fullPath = basePath .. filename
		local success = pcall(function()
			writefile(fullPath, content)
		end)
		
		if success then
			return true, fullPath
		end
	end
	
	return false, nil
end

local function saveOutputs()
	print("\nüîÑ ATTEMPTING TO SAVE FILES...")
	print("==========================================\n")
	
	local baseFilename = string.format("GameDump_%s_%s", dumpData.GameInfo.PlaceId, dumpData.Timestamp)
	local textOutput = generateTextOutput()
	
	-- Method 1: Text file
	print("üìÑ [1/3] Saving text report...")
	local success1, path1 = tryWriteFile(baseFilename .. ".txt", textOutput)
	if success1 then
		print("‚úÖ SUCCESS: " .. path1)
	else
		print("‚ùå FAILED: Could not save text file")
	end
	
	-- Method 2: JSON file
	print("\nüìÑ [2/3] Saving JSON data...")
	local success2, jsonData = pcall(function()
		return HttpService:JSONEncode(dumpData)
	end)
	if success2 then
		local success2b, path2 = tryWriteFile(baseFilename .. ".json", jsonData)
		if success2b then
			print("‚úÖ SUCCESS: " .. path2)
		else
			print("‚ùå FAILED: Could not save JSON file")
		end
	else
		print("‚ùå FAILED: JSON encoding error")
	end
	
	-- Method 3: Clipboard
	print("\nüìã [3/3] Copying to clipboard...")
	local success3 = pcall(function()
		setclipboard(textOutput)
	end)
	if success3 then
		print("‚úÖ SUCCESS: Content copied to clipboard!")
	else
		print("‚ùå FAILED: Clipboard not supported")
	end
	
	-- Method 4: Console output (always works)
	print("\nüì∫ [BONUS] Console output available")
	print("‚úÖ You can scroll up and copy manually\n")
	
	print("==========================================")
	print("üíæ SAVE ATTEMPTS COMPLETE")
	print("==========================================\n")
	
	-- Print locations to check
	print("üìÇ CHECK THESE LOCATIONS:")
	for i, path in ipairs(CONFIG.SAVE_PATHS) do
		print(string.format("  [%d] %s", i, path))
	end
	print("\n‚ö†Ô∏è  If files not found, check executor's workspace folder")
	print("‚ö†Ô∏è  On Android: /storage/emulated/0/Download/ is most likely\n")
	
	return success1 or success2 or success3
end

-- ========================================
-- EXECUTION
-- ========================================
startDump()
local saveSuccess = saveOutputs()

if not saveSuccess then
	print("\n‚ö†Ô∏è  ALL SAVE METHODS FAILED!")
	print("üìã Printing full output to console...\n")
	print(generateTextOutput())
end

print("\nüéâ DUMPER COMPLETE - Check output above!")

return dumpData
