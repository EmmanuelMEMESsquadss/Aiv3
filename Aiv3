-- LocalScript (StarterPlayerScripts)
-- Mobile Lock-On + Camlock System (SMOOTH ROTATION + COLLAPSIBLE UI)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")

-- Only run on mobile
if not UserInputService.TouchEnabled then
	return
end

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera
local character, humanoid, hrp
local isDisabled = false

-- ROTATION SETTINGS (Adjustable)
local rotationSpeed = 0.15  -- Default: Balanced (0.05 = Instant, 0.3 = Very Smooth)

local function setupCharacter(char)
	character = char
	humanoid = char:WaitForChild("Humanoid")
	hrp = char:FindFirstChild("HumanoidRootPart") or char:WaitForChild("HumanoidRootPart")
	
	if humanoid then 
		humanoid.AutoRotate = true 
		
		humanoid.StateChanged:Connect(function(oldState, newState)
			if newState == Enum.HumanoidStateType.Physics or 
			   newState == Enum.HumanoidStateType.Ragdoll or
			   newState == Enum.HumanoidStateType.FallingDown or
			   newState == Enum.HumanoidStateType.PlatformStanding then
				isDisabled = true
			elseif newState == Enum.HumanoidStateType.Running or
			       newState == Enum.HumanoidStateType.Landed or
			       newState == Enum.HumanoidStateType.Jumping then
				isDisabled = false
			end
		end)
		
		humanoid:GetPropertyChangedSignal("PlatformStand"):Connect(function()
			isDisabled = humanoid.PlatformStand
		end)
		
		humanoid:GetPropertyChangedSignal("Sit"):Connect(function()
			if humanoid.Sit then isDisabled = true end
		end)
	end
	
	if hrp then
		hrp.ChildAdded:Connect(function(child)
			if child:IsA("Weld") or child:IsA("WeldConstraint") or 
			   child:IsA("AlignPosition") or child:IsA("AlignOrientation") or 
			   child:IsA("RopeConstraint") then
				isDisabled = true
				child.AncestryChanged:Connect(function()
					if not child:IsDescendantOf(game) then
						task.wait(0.5)
						isDisabled = false
					end
				end)
			end
		end)
	end
end

if player.Character then setupCharacter(player.Character) end
player.CharacterAdded:Connect(setupCharacter)

-- ========== COLLAPSIBLE UI ==========
local gui = Instance.new("ScreenGui")
gui.Name = "LockOnUI"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local isUIExpanded = false

-- Minimized Dot Button
local dotBtn = Instance.new("TextButton")
dotBtn.Size = UDim2.new(0, 50, 0, 50)
dotBtn.Position = UDim2.new(0.06, 0, 0.8, 0)
dotBtn.Text = "üéØ"
dotBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
dotBtn.TextColor3 = Color3.new(1, 1, 1)
dotBtn.Font = Enum.Font.GothamBold
dotBtn.TextSize = 24
dotBtn.Active = true
dotBtn.Parent = gui

local dotCorner = Instance.new("UICorner")
dotCorner.CornerRadius = UDim.new(0.5, 0)
dotCorner.Parent = dotBtn

-- Container for expanded buttons
local container = Instance.new("Frame")
container.Size = UDim2.new(0, 360, 0, 60)
container.Position = UDim2.new(0.06, 0, 0.8, 0)
container.BackgroundTransparency = 1
container.Visible = false
container.Parent = gui

-- Character Lock Button
local charLockBtn = Instance.new("TextButton")
charLockBtn.Size = UDim2.new(0, 110, 0, 50)
charLockBtn.Position = UDim2.new(0, 0, 0, 0)
charLockBtn.Text = "CHAR LOCK"
charLockBtn.BackgroundColor3 = Color3.fromRGB(36, 137, 206)
charLockBtn.TextColor3 = Color3.new(1, 1, 1)
charLockBtn.Font = Enum.Font.GothamBold
charLockBtn.TextSize = 14
charLockBtn.Active = true
charLockBtn.Parent = container

local charCorner = Instance.new("UICorner")
charCorner.CornerRadius = UDim.new(0, 8)
charCorner.Parent = charLockBtn

-- Status indicator
local charDot = Instance.new("Frame")
charDot.Size = UDim2.new(0, 8, 0, 8)
charDot.Position = UDim2.new(1, -12, 0, 4)
charDot.BackgroundColor3 = Color3.fromRGB(100, 255, 100)
charDot.BorderSizePixel = 0
charDot.Parent = charLockBtn

local charDotCorner = Instance.new("UICorner")
charDotCorner.CornerRadius = UDim.new(0.5, 0)
charDotCorner.Parent = charDot

-- Camlock Button
local camLockBtn = Instance.new("TextButton")
camLockBtn.Size = UDim2.new(0, 110, 0, 50)
camLockBtn.Position = UDim2.new(0, 120, 0, 0)
camLockBtn.Text = "CAM LOCK"
camLockBtn.BackgroundColor3 = Color3.fromRGB(206, 137, 36)
camLockBtn.TextColor3 = Color3.new(1, 1, 1)
camLockBtn.Font = Enum.Font.GothamBold
camLockBtn.TextSize = 14
camLockBtn.Active = true
camLockBtn.Parent = container

local camCorner = Instance.new("UICorner")
camCorner.CornerRadius = UDim.new(0, 8)
camCorner.Parent = camLockBtn

-- Settings Button (Gear Icon)
local settingsBtn = Instance.new("TextButton")
settingsBtn.Size = UDim2.new(0, 50, 0, 50)
settingsBtn.Position = UDim2.new(0, 240, 0, 0)
settingsBtn.Text = "‚öôÔ∏è"
settingsBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
settingsBtn.TextColor3 = Color3.new(1, 1, 1)
settingsBtn.Font = Enum.Font.GothamBold
settingsBtn.TextSize = 24
settingsBtn.Active = true
settingsBtn.Parent = container

local settingsCorner = Instance.new("UICorner")
settingsCorner.CornerRadius = UDim.new(0, 8)
settingsCorner.Parent = settingsBtn

-- Close Button (X)
local closeBtn = Instance.new("TextButton")
closeBtn.Size = UDim2.new(0, 50, 0, 50)
closeBtn.Position = UDim2.new(0, 300, 0, 0)
closeBtn.Text = "‚úï"
closeBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
closeBtn.TextColor3 = Color3.new(1, 1, 1)
closeBtn.Font = Enum.Font.GothamBold
closeBtn.TextSize = 24
closeBtn.Active = true
closeBtn.Parent = container

local closeCorner = Instance.new("UICorner")
closeCorner.CornerRadius = UDim.new(0, 8)
closeCorner.Parent = closeBtn

-- Settings Panel
local settingsPanel = Instance.new("Frame")
settingsPanel.Size = UDim2.new(0, 300, 0, 150)
settingsPanel.Position = UDim2.new(0, 0, 0, -160)
settingsPanel.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
settingsPanel.Visible = false
settingsPanel.Parent = container

local panelCorner = Instance.new("UICorner")
panelCorner.CornerRadius = UDim.new(0, 10)
panelCorner.Parent = settingsPanel

-- Settings Title
local settingsTitle = Instance.new("TextLabel")
settingsTitle.Size = UDim2.new(1, -20, 0, 30)
settingsTitle.Position = UDim2.new(0, 10, 0, 10)
settingsTitle.Text = "ROTATION SPEED"
settingsTitle.BackgroundTransparency = 1
settingsTitle.TextColor3 = Color3.new(1, 1, 1)
settingsTitle.Font = Enum.Font.GothamBold
settingsTitle.TextSize = 16
settingsTitle.TextXAlignment = Enum.TextXAlignment.Left
settingsTitle.Parent = settingsPanel

-- Speed Label
local speedLabel = Instance.new("TextLabel")
speedLabel.Size = UDim2.new(1, -20, 0, 20)
speedLabel.Position = UDim2.new(0, 10, 0, 50)
speedLabel.Text = "Balanced"
speedLabel.BackgroundTransparency = 1
speedLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
speedLabel.Font = Enum.Font.Gotham
speedLabel.TextSize = 14
speedLabel.TextXAlignment = Enum.TextXAlignment.Center
speedLabel.Parent = settingsPanel

-- Slider Background
local sliderBg = Instance.new("Frame")
sliderBg.Size = UDim2.new(1, -40, 0, 8)
sliderBg.Position = UDim2.new(0, 20, 0, 85)
sliderBg.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
sliderBg.BorderSizePixel = 0
sliderBg.Parent = settingsPanel

local sliderBgCorner = Instance.new("UICorner")
sliderBgCorner.CornerRadius = UDim.new(0.5, 0)
sliderBgCorner.Parent = sliderBg

-- Slider Fill
local sliderFill = Instance.new("Frame")
sliderFill.Size = UDim2.new(0.5, 0, 1, 0)
sliderFill.BackgroundColor3 = Color3.fromRGB(36, 137, 206)
sliderFill.BorderSizePixel = 0
sliderFill.Parent = sliderBg

local sliderFillCorner = Instance.new("UICorner")
sliderFillCorner.CornerRadius = UDim.new(0.5, 0)
sliderFillCorner.Parent = sliderFill

-- Slider Button
local sliderBtn = Instance.new("TextButton")
sliderBtn.Size = UDim2.new(0, 25, 0, 25)
sliderBtn.Position = UDim2.new(0.5, -12.5, 0.5, -12.5)
sliderBtn.Text = ""
sliderBtn.BackgroundColor3 = Color3.new(1, 1, 1)
sliderBtn.Active = true
sliderBtn.Parent = sliderBg

local sliderBtnCorner = Instance.new("UICorner")
sliderBtnCorner.CornerRadius = UDim.new(0.5, 0)
sliderBtnCorner.Parent = sliderBtn

-- Speed presets text
local presetText = Instance.new("TextLabel")
presetText.Size = UDim2.new(1, -40, 0, 20)
presetText.Position = UDim2.new(0, 20, 0, 110)
presetText.Text = "Fast ‚Üê          ‚Üí Smooth"
presetText.BackgroundTransparency = 1
presetText.TextColor3 = Color3.fromRGB(150, 150, 150)
presetText.Font = Enum.Font.Gotham
presetText.TextSize = 12
presetText.Parent = settingsPanel

-- Slider Logic
local draggingSlider = false

local function updateSlider(position)
	local bgPos = sliderBg.AbsolutePosition.X
	local bgSize = sliderBg.AbsoluteSize.X
	local relativeX = math.clamp(position - bgPos, 0, bgSize)
	local percent = relativeX / bgSize
	
	-- Update slider position
	sliderBtn.Position = UDim2.new(percent, -12.5, 0.5, -12.5)
	sliderFill.Size = UDim2.new(percent, 0, 1, 0)
	
	-- Map to rotation speed (0.05 to 0.3)
	rotationSpeed = 0.05 + (percent * 0.25)
	
	-- Update label
	if percent < 0.3 then
		speedLabel.Text = "Fast"
		speedLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
	elseif percent < 0.7 then
		speedLabel.Text = "Balanced"
		speedLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
	else
		speedLabel.Text = "Smooth"
		speedLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
	end
end

sliderBtn.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or 
	   input.UserInputType == Enum.UserInputType.Touch then
		draggingSlider = true
	end
end)

UserInputService.InputEnded:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or 
	   input.UserInputType == Enum.UserInputType.Touch then
		draggingSlider = false
	end
end)

UserInputService.InputChanged:Connect(function(input)
	if draggingSlider and (input.UserInputType == Enum.UserInputType.MouseMovement or 
	                       input.UserInputType == Enum.UserInputType.Touch) then
		updateSlider(input.Position.X)
	end
end)

-- Initialize slider to default (Balanced)
updateSlider(sliderBg.AbsolutePosition.X + sliderBg.AbsoluteSize.X * 0.5)

-- UI Toggle Logic
local function toggleUI()
	isUIExpanded = not isUIExpanded
	dotBtn.Visible = not isUIExpanded
	container.Visible = isUIExpanded
	if not isUIExpanded then
		settingsPanel.Visible = false
	end
end

dotBtn.Activated:Connect(toggleUI)
closeBtn.Activated:Connect(toggleUI)

settingsBtn.Activated:Connect(function()
	settingsPanel.Visible = not settingsPanel.Visible
end)

-- Draggable
local dragging, dragInput, dragStart, startPos

local function updateDrag(input)
	local delta = input.Position - dragStart
	if isUIExpanded then
		container.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	else
		dotBtn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X,
			startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end

local function startDrag(btn, input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or 
	   input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		dragStart = input.Position
		startPos = btn.Position
		dragInput = input
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then 
				dragging = false 
			end
		end)
	end
end

dotBtn.InputBegan:Connect(function(input) startDrag(dotBtn, input) end)
container.InputBegan:Connect(function(input) startDrag(container, input) end)

UserInputService.InputChanged:Connect(function(input)
	if dragging and input == dragInput then updateDrag(input) end
end)

-- Lock state
local MAX_DIST = 100
local charLockTarget, camLockTarget
local lockBillboard

local function detachBillboard()
	if lockBillboard then
		lockBillboard:Destroy()
		lockBillboard = nil
	end
end

local function attachBillboard(model, color)
	detachBillboard()
	local targetHrp = model:FindFirstChild("HumanoidRootPart")
	if not targetHrp then return end
	local bb = Instance.new("BillboardGui")
	bb.Size = UDim2.new(0, 120, 0, 40)
	bb.StudsOffset = Vector3.new(0, 3.2, 0)
	bb.AlwaysOnTop = true
	bb.Parent = targetHrp
	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, 0, 1, 0)
	label.BackgroundTransparency = 1
	label.Text = "LOCKED"
	label.TextScaled = true
	label.Font = Enum.Font.GothamBold
	label.TextColor3 = color
	label.Parent = bb
	lockBillboard = bb
end

local function isValidTarget(model)
	if not model or not model:IsA("Model") then return false end
	local hum = model:FindFirstChildWhichIsA("Humanoid")
	local part = model:FindFirstChild("HumanoidRootPart")
	if not hum or not part or hum.Health <= 0 then return false end
	if model == character then return false end
	if Players:GetPlayerFromCharacter(model) == player then return false end
	return true
end

local function getNearestTarget()
	if not hrp then return end
	local nearest, dist = nil, MAX_DIST
	for _, pl in ipairs(Players:GetPlayers()) do
		if pl ~= player and pl.Character and isValidTarget(pl.Character) then
			local d = (hrp.Position - pl.Character.HumanoidRootPart.Position).Magnitude
			if d < dist then
				dist = d
				nearest = pl.Character
			end
		end
	end
	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Model") and isValidTarget(obj) then
			local targetHrp = obj:FindFirstChild("HumanoidRootPart")
			if targetHrp then
				local d = (hrp.Position - targetHrp.Position).Magnitude
				if d < dist then
					dist = d
					nearest = obj
				end
			end
		end
	end
	return nearest
end

function unlockChar()
	charLockTarget = nil
	if humanoid then humanoid.AutoRotate = true end
	charLockBtn.Text = "CHAR LOCK"
	charLockBtn.BackgroundColor3 = Color3.fromRGB(36, 137, 206)
	if not camLockTarget then detachBillboard() end
end

local function unlockCam()
	camLockTarget = nil
	camLockBtn.Text = "CAM LOCK"
	camLockBtn.BackgroundColor3 = Color3.fromRGB(206, 137, 36)
	if not charLockTarget then detachBillboard() end
	if camera then
		camera.CameraType = Enum.CameraType.Custom
		if humanoid then camera.CameraSubject = humanoid end
	end
end

-- Character Lock Button
charLockBtn.Activated:Connect(function()
	if charLockTarget then
		unlockChar()
	else
		local t = getNearestTarget()
		if t then
			charLockTarget = t
			if humanoid then humanoid.AutoRotate = false end
			attachBillboard(t, Color3.fromRGB(255, 80, 80))
			charLockBtn.Text = "UNLOCK"
			charLockBtn.BackgroundColor3 = Color3.fromRGB(206, 36, 36)
		else
			charLockBtn.Text = "NO TARGET"
			task.delay(1, function()
				if not charLockTarget then charLockBtn.Text = "CHAR LOCK" end
			end)
		end
	end
end)

-- Camlock Button
camLockBtn.Activated:Connect(function()
	if camLockTarget then
		unlockCam()
	else
		local t = getNearestTarget()
		if t then
			camLockTarget = t
			attachBillboard(t, Color3.fromRGB(80, 255, 80))
			camLockBtn.Text = "UNLOCK"
			camLockBtn.BackgroundColor3 = Color3.fromRGB(36, 206, 36)
		else
			camLockBtn.Text = "NO TARGET"
			task.delay(1, function()
				if not camLockTarget then camLockBtn.Text = "CAM LOCK" end
			end)
		end
	end
end)

-- Update status indicator
spawn(function()
	while true do
		wait(0.1)
		charDot.BackgroundColor3 = isDisabled and Color3.fromRGB(255, 80, 80) or Color3.fromRGB(100, 255, 100)
	end
end)

-- Character Rotation loop (SMOOTH ROTATION - FIXES CAMERA BUG!)
RunService.RenderStepped:Connect(function()
	if charLockTarget and hrp and humanoid and humanoid.Health > 0 then
		
		if isDisabled or humanoid.PlatformStand or humanoid.Sit then
			if humanoid then humanoid.AutoRotate = true end
			return
		end
		
		if humanoid then humanoid.AutoRotate = false end
		
		local targetHRP = charLockTarget:FindFirstChild("HumanoidRootPart")
		local targetHum = charLockTarget:FindFirstChildWhichIsA("Humanoid")
		
		if targetHRP and targetHum and targetHum.Health > 0 then
			local lookPos = Vector3.new(targetHRP.Position.X, hrp.Position.Y, targetHRP.Position.Z)
			local targetCFrame = CFrame.new(hrp.Position, lookPos)
			
			-- SMOOTH ROTATION (KEY FIX!)
			hrp.CFrame = hrp.CFrame:Lerp(targetCFrame, rotationSpeed)
		else
			unlockChar()
		end
	else
		if humanoid and not charLockTarget then
			humanoid.AutoRotate = true
		end
	end
end)

-- Camera Lock loop
local CAMERA_DISTANCE = 15
local CAMERA_HEIGHT = 3

RunService.RenderStepped:Connect(function()
	if camLockTarget and camera and hrp and humanoid then
		camera.CameraType = Enum.CameraType.Scriptable
		
		local targetHRP = camLockTarget:FindFirstChild("HumanoidRootPart")
		local targetHum = camLockTarget:FindFirstChildWhichIsA("Humanoid")
		
		if targetHRP and targetHum and targetHum.Health > 0 then
			local playerPos = hrp.Position + Vector3.new(0, CAMERA_HEIGHT, 0)
			local directionToTarget = (targetHRP.Position - playerPos).Unit
			
			if directionToTarget.Magnitude < 0.5 then
				directionToTarget = hrp.CFrame.LookVector
			end
			
			local cameraPosition = playerPos - (directionToTarget * CAMERA_DISTANCE)
			local targetLook = CFrame.new(cameraPosition, targetHRP.Position)
			
			camera.CFrame = camera.CFrame:Lerp(targetLook, 0.2)
		else
			unlockCam()
		end
	end
	
	if not camLockTarget and camera.CameraType == Enum.CameraType.Scriptable then
		camera.CameraType = Enum.CameraType.Custom
		camera.CameraSubject = humanoid
	end
end)

print("Mobile Lock System with SMOOTH ROTATION loaded!")
print("üéØ Click dot to expand | ‚öôÔ∏è Adjust rotation speed | No more camera bugs!")
